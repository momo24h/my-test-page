<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è€å­é“å¾·ç»ï¼šåŸæ–‡è¯‘æ–‡æ³¨é‡Š</title>
    <style>
        /* é»˜è®¤ä¸»é¢˜ (1: å…¸é›…) */
        :root, [data-theme="1"] {
            --bg-color: #fcfaf7;
            --note-bg: #f3f0e9;
            --item-bg: #ece5d8;
            --last-bg: #e5e9f0;
            --accent-color: #a67c52;
            --text-main: #2c3e50;
            --title-color: #1a1a1a;
            --guide-color: #8c8c8c;
            --highlight-blue: rgba(52, 152, 219, 0.2);
            --error-red: #ff4d4f;
        }

        /* ä¸»é¢˜ 2: æ²‰é™ (å¤œé—´) */
        [data-theme="2"] {
            --bg-color: #2b2622;
            --note-bg: #36302a;
            --item-bg: #3f3932;
            --last-bg: #332d28;
            --accent-color: #d4a373;
            --text-main: #bdae93;
            --title-color: #ebdbb2;
            --guide-color: #928374;
        }

		/* ä¸»é¢˜ 3: ç„å¢¨ (æ·±è‰²) */
		[data-theme="3"] {
			--bg-color: #1a1a1a;
			--note-bg: #262626;
			--item-bg: #333333;
			--last-bg: #202020;
			--accent-color: #c9a063; /* å¤é“œé‡‘ */
			--text-main: #d1d1d1;
			--title-color: #ffffff;
			--guide-color: #888888;
		}

        /* ä¸»é¢˜ 4: æš®è‰² */
        [data-theme="4"] {
            --bg-color: #1a1c22;
            --note-bg: #24272e;
            --item-bg: #2d313a;
            --last-bg: #1e222a;
            --accent-color: #6a88b5;
            --text-main: #a0a6b5;
            --title-color: #d1d6e0;
            --guide-color: #62697a;
        }

		/* ä¸»é¢˜ 5: é’ç“· */
		[data-theme="5"] {
			--bg-color: #f0f7f4;
			--note-bg: #e4eeea;
			--item-bg: #d8e6e0;
			--last-bg: #eaf2ef;
			--accent-color: #5b8a72;
			--text-main: #3d4f46;
			--title-color: #2c3e35;
			--guide-color: #7a9e8d;
		}

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        
        body { 
            font-family: 
				"Source Han Serif CN", 
				"Noto Serif CJK SC", 
				"Songti SC", 
				"STSong", 
				"SimSun", 
				"Webå®‹ä½“", 
				serif;
            line-height: 1.8; max-width: 800px; margin: 0 auto; padding: 20px 18px 60px;
            background-color: var(--bg-color); color: var(--text-main);
            scroll-behavior: smooth;
            transition: background-color 0.3s, color 0.3s;
        }

        /* æš—è‰²æ¨¡å¼é’ˆå¯¹å¯¼èˆªæ çš„å¾®è°ƒ */
        body.dark-mode #nav-panel { background: #242526; color: #d1d1d1; }
        body.dark-mode .nav-item { border-bottom: 1px solid #333; }

        #error-monitor { 
            margin: 10px; padding: 15px; background: #fff1f0; 
            border: 1px solid #ffa39e; border-radius: 8px; 
            color: var(--error-red); display: none; font-size: 0.9em;
            line-height: 1.5;
        }

        header { text-align: center; margin-bottom: 0px; padding-bottom: 10px; position: relative; z-index: 10; background: var(--bg-color); }
        .main-title { font-size: 2.1em; color: var(--title-color); margin: 0; font-weight: 400; letter-spacing: 4px; cursor: pointer; user-select: none; opacity: 0.9;}
        

        #reveal-btn { font-size: 1.5em; cursor: pointer; margin-top: 10px; display: inline-block; user-select: none;}

        .reveal-container { 
            position: relative; 
            overflow: hidden; 
			margin-top: 0;
        }
        
        .hidden-info {
			display: none;
        }

		.reveal-container.open .hidden-info {
    		display: block;
		}
		
		.reveal-container.open  {
    		margin-top: 10px;
		}
        
        .project-meta {
            margin: 10px auto; padding: 15px 20px; max-width: 500px; font-size: 0.82em;
            color: var(--guide-color); border-top: 1px solid rgba(166, 124, 82, 0.2); border-bottom: 1px solid rgba(166, 124, 82, 0.2);
        }
        .meta-item { display: flex; justify-content: space-between; margin: 6px 0; }
        .meta-label { color: var(--accent-color); font-weight: 500; }
        .meta-value a { color: var(--guide-color); text-decoration: none; border-bottom: 1px solid #ccc; }

        #moving-content {
            position: relative;
            z-index: 2;
            background: var(--bg-color);
        }

        #menu-btn {
            position: fixed; right: 20px; bottom: 30px; width: 50px; height: 50px;
            background: var(--accent-color); color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; z-index: 100;
        }
        #nav-panel {
            position: fixed; top: 0; right: -280px; width: 280px; height: 100%;
            background: var(--bg-color); box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            z-index: 101; transition: 0.3s ease; padding: 0px; overflow-y: auto;
            overscroll-behavior: contain; -webkit-overflow-scrolling: touch;
        }
        #nav-panel.open { right: 0; }
        .nav-item { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; font-size: 0.95em; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; z-index: 99; }

        @keyframes blueFlash {
            0% { background-color: transparent; }
            30% { background-color: var(--highlight-blue); }
            100% { background-color: transparent; }
        }
        .flash-active { animation: blueFlash 1.5s ease-out; border-radius: 8px; }

        h2 { margin: 40px 0 20px; font-size: 1.5em; font-weight: 400; cursor: pointer; padding: 10px 0; text-align: center; border-bottom: 1px solid rgba(166, 124, 82, 0.1); color: var(--title-color); }

        .section-wrapper { margin-bottom: 12px; position: relative; }
        .content-text { margin: 0; text-indent: 2em; text-align: justify; font-size: 1.15em; position: relative; }
        .indent-trigger { position: absolute; left: 0; top: 0; width: 2.5em; height: 1.6em; cursor: pointer; z-index: 10; }
        
        .annotation-box { display: none; margin: 12px 0 20px; padding: 16px; background-color: var(--note-bg); border-radius: 8px; font-size: 0.95em; border-left: 3px solid var(--accent-color); }
        .details-indicator { display: block; margin: 8px auto 0; text-align: center; color: var(--accent-color); cursor: pointer; font-size: 1.2em; opacity: 0.6; }
        .details-content { display: none; margin-top: 15px; }
        
        .item-container ol { margin: 0; padding-left: 1.5em; color: var(--text-main); }
        .item-container li { margin-bottom: 8px; }
        .item-container li::marker { color: var(--accent-color); font-weight: bold; }

        .last-container { background: var(--last-bg); padding: 12px; border-radius: 6px; margin-top: 10px; border-top: 1px solid rgba(0,0,0,0.05); }
        .term-tag { border-bottom: 1.5px dashed var(--accent-color); color: var(--accent-color); font-weight: 500; }

		footer { margin: 80px 0 60px; text-align: center; }
		.end-mark { 
			display: flex; 
			align-items: center; 
			justify-content: center;
			font-size: 1em; 
			color: var(--accent-color); 
			opacity: 0.5; 
			letter-spacing: 6px; 
		}
		.end-mark::before, .end-mark::after {
			content: ""; 
			flex: 1; 
			height: 1px; 
			background: var(--accent-color); 
			opacity: 0.3; 
			margin: 0 20px;
			max-width: 100px; /* è®¾ç½®æ¨ªçº¿çš„æœ€å¤§é•¿åº¦ */
		}
    
        .toggle-wrapper { display: flex; flex-direction: column; gap: 12px; padding: 0px 18px 20px; border-bottom: 1px solid rgba(166, 124, 82, 0.2); background: var(--bg-color); }
        .switch-row { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .switch-container { display: flex; align-items: center; gap: 8px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(16px); }
        .switch-label { font-size: 0.85em; color: var(--guide-color); }

        #theme-toggle {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; padding: 10px 15px; border: 1.5px solid var(--accent-color);
            border-radius: 8px; color: var(--accent-color); cursor: pointer;
            font-weight: bold; transition: all 0.2s; background: transparent;
            margin-top: 15px; margin-bottom: 5px;
        }
        #theme-toggle:active { transform: scale(0.98); opacity: 0.8; }
        .theme-name { font-size: 0.9em; }
        .theme-id { font-family: monospace; background: var(--accent-color); color: var(--bg-color); padding: 0px 8px; border-radius: 4px; }
    </style>
</head>
<body>

<script id="data-part-1" type="application/json">
[
    ["ç¬¬ä¸€ç« ğŸŒ±é“å¯é“ä¹Ÿï¼Œéæ†é“ä¹Ÿã€‚åå¯åä¹Ÿï¼Œéæ†åä¹Ÿã€‚ğŸŒ±ç„¡åï¼Œè¬ç‰©ä¹‹å§‹ä¹Ÿï¼›æœ‰åï¼Œè¬ç‰©ä¹‹æ¯ä¹Ÿã€‚æ•…æ†ç„¡æ¬²ä¹Ÿï¼Œä»¥è§€å…¶çœ‡ï¼›æ†æœ‰æ¬²ä¹Ÿï¼Œä»¥è§€å…¶æ‰€å¾¼ã€‚å…©è€…åŒå‡ºï¼Œç•°ååŒè¬‚ã€‚ç„ä¹‹åˆç„ï¼Œè¡†çœ‡ä¹‹é–€ã€‚",
		["å¯ä»¥ä»å¤–éƒ¨æè¿°çš„é“ï¼Œä¸æ˜¯æ’ä¹…é€‚ç”¨ä¹‹é“ã€‚å¯ä»¥ä»å¤–éƒ¨å‘½åçš„åï¼Œä¸æ˜¯æ’ä¹…é€‚ç”¨ä¹‹åã€‚", 
			"âœï¸é“ï¼šç†è®ºï¼Œé€šå¾€å¹¸ç¦çš„è·¯ã€‚", 
			"âœï¸åï¼šæ¨¡å‹ã€ç†è®ºè¦ç´ ã€‚æ˜¯å¯¹ç°å®æŠ½è±¡çš„ç»“æœï¼Œæ˜¯æ„æˆç†è®ºçš„è¦ç´ ï¼Œæ˜¯ä¿è¯ç†è®ºä¸å®é™…ç›¸ç¬¦çš„å…³é”®ã€‚"
		],
		["[termæ— å]ï¼Œæ˜¯[termä¸‡ç‰©]ä¹‹[termå§‹]ï¼›[termæœ‰å]ï¼Œæ˜¯[termä¸‡ç‰©]ä¹‹[termæ¯]ã€‚æ‰€ä»¥ï¼Œæ€»æ˜¯æ— æ¬²ï¼Œä»¥è§‚å¯Ÿ[termå§‹]ä¾§ç»†å¾®è§„å¾‹ï¼›æ€»æ˜¯æœ‰æ¬²ï¼Œä»¥è§‚å¯Ÿ[termæ¯]ä¾§æ‰€å±•ç°çš„è¾¹ç•Œã€‚[termå§‹]ä¸[termæ¯]åŒæ—¶æ˜¾ç°ï¼Œä¸åŒçš„åæŒ‡å‘åŒç‰©ã€‚æ„ä¹‰æ·±è¿œå†æ·±è¿œï¼Œä¼—ç»†å¾®è§„å¾‹çš„å…¥å£ã€‚"]
    ]
]
</script>

<script id="data-part-2" type="application/json">
[
	["ç¬¬ä¸‰åå…«ç« ğŸŒ±ä¸Šå¾·ä¸å¾·ï¼Œæ˜¯ä»¥æœ‰å¾·ã€‚ä¸‹å¾·ä¸å¤±å¾·ï¼Œæ˜¯ä»¥ç„¡å¾·ã€‚ğŸŒ±ä¸Šå¾·ç„¡çˆ²è€Œç„¡ä»¥çˆ²ä¹Ÿï¼Œä¸Šä»çˆ²ä¹‹è€Œç„¡ä»¥çˆ²ä¹Ÿï¼Œä¸Šç¾©çˆ²ä¹‹è€Œæœ‰ä»¥çˆ²ä¹Ÿï¼Œä¸Šç¦®çˆ²ä¹‹è€Œè«ä¹‹æ‡‰ä¹Ÿï¼Œå‰‡æ”˜è‡‚è€Œæ‰”ä¹‹ã€‚ğŸŒ±æ•…å¤±é“è€Œå¾Œå¾·ï¼Œå¤±å¾·è€Œå¾Œä»ï¼Œå¤±ä»è€Œå¾Œç¾©ï¼Œå¤±ç¾©è€Œå¾Œç¦®ã€‚å¤«ç¦®è€…ï¼Œå¿ ä¿¡ä¹‹è–„è€Œäº‚ä¹‹é¦–ä¹Ÿï¼›å‰è­˜è€…ï¼Œé“ä¹‹è¯è€Œæ„šä¹‹é¦–ä¹Ÿã€‚ğŸŒ±æ˜¯ä»¥å¤§ä¸ˆå¤«ï¼Œå±…å…¶åšä¸å±…å…¶è–„ï¼›å±…å…¶å¯¦ï¼Œä¸å±…å…¶è¯ã€‚æ•…å»å½¼å–æ­¤ã€‚",
		["[todo]ä¸Š[termå¾·]æ²¡æœ‰ç¾å¾·ï¼Œå› æ­¤ç¬¦åˆåº•å±‚æœºåˆ¶ã€‚ä¸‹[termå¾·]ä¸ä¸¢æ‰ç¾å¾·ï¼Œå› æ­¤è¿èƒŒåº•å±‚æœºåˆ¶ã€‚",
			"ğŸ“ä¸Šå¾·æ˜¯åŸºäºäº‹å®é©±åŠ¨çš„â€œä¸å¾—ä¸â€ï¼Œä¸‹å¾·æ˜¯åŸºäºå½¢è±¡é©±åŠ¨çš„â€œåº”è¯¥â€ã€‚"
		],
		["ä¸Š[termå¾·]ä»¥æ— [termä¸º]å¤„äº‹ï¼Œä¸è®¤ä¸ºæœ‰æ‰€ä½œä¸ºã€‚ä¸Šâ€œä»â€ä»¥æœ‰[termä¸º]å¤„äº‹ï¼Œä¸è®¤ä¸ºæœ‰æ‰€ä½œä¸ºã€‚ä¸Šâ€œä¹‰â€ä»¥æœ‰[termä¸º]å¤„äº‹ï¼Œè®¤ä¸ºæœ‰æ‰€ä½œä¸ºã€‚ä¸Šâ€œç¤¼â€ä»¥æœ‰[termä¸º]å¤„äº‹ï¼Œæ²¡æœ‰å¾—åˆ°é¢„æœŸå›åº”ï¼Œå°±å·èµ·è¢–å­éœ²å‡ºèƒ³è†Šï¼Œæ‹‰æ‹½å¯¹æ–¹ã€‚"],
		["æ‰€ä»¥ï¼Œä¸¢æ‰[termé“]ä¹‹åæ˜¯[termå¾·]ï¼Œä¸¢æ‰[termå¾·]ä¹‹åæ˜¯â€œä»â€ï¼Œä¸¢æ‰â€œä»â€ä¹‹åæ˜¯â€œä¹‰â€ï¼Œå¤±æ‰â€œä¹‰â€ä¹‹åæ˜¯â€œç¤¼â€ã€‚â€œç¤¼â€è¿™ä¸ªä¸œè¥¿å•Šï¼Œæ˜¯å¿ ä¿¡çš„æµ…è–„è¡¨ç°ï¼Œæ˜¯ç¥¸ä¹±ä¹‹é¦–ã€‚ä»è¡¨ç°å±‚é¢å»è®¤è¯†[termå¾·]çš„ï¼Œéƒ½æ˜¯åº•å±‚æœºåˆ¶æ‰€å±•ç°çš„æµ®åï¼Œæ˜¯æ„šæ˜§è¿·è¯¯ä¹‹é¦–ã€‚"],
		["å› æ­¤å¤§ä¸ˆå¤«ï¼Œå±…äº[termå¾·]çš„æ·±åšå¤„è€Œä¸å±…äº[termå¾·]çš„æµ…è–„å¤„ï¼›å±…äº[termå¾·]çš„äº‹å®è€Œä¸å±…äº[termå¾·]çš„æµ®åã€‚æ‰€ä»¥ï¼ŒæŠ›å¼ƒæµ…è–„ã€æµ®åï¼Œé€‰æ‹©æ·±åšã€äº‹å®ã€‚"]
	]
]
</script>

<div id="error-monitor"></div>
<div id="menu-btn">ğŸ“–</div>
<div id="overlay"></div>
<nav id="nav-panel">
    <div class="toggle-wrapper">
        <div id="theme-toggle">
            <span class="theme-name">é…è‰²æ–¹æ¡ˆ</span>
            <span class="theme-id">1</span>
        </div>
        <div class="switch-row">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="expand-toggle">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">è‡ªåŠ¨å±•å¼€</span>
            </div>
        </div>
        <div class="switch-row">
            <div class="switch-container">
                <label class="switch">
                    <input type="checkbox" id="sync-toggle">
                    <span class="slider"></span>
                </label>
                <span class="switch-label">åŒæ—¶å±•å¼€</span>
            </div>
        </div>
    </div>
</nav>

<header>
    <h1 class="main-title">è€å­é“å¾·ç»</br>åŸæ–‡è¯‘æ–‡æ³¨é‡Š</h1>
    <div id="reveal-btn" style="font-weight: bold; -webkit-text-stroke: 0.6px currentColor;">â“˜</div>
</header>

<div class="reveal-container" id="reveal-area">
    <div class="hidden-info" id="info-layer">
        <div class="project-meta">
            <div style="text-align: right; margin: 10px 0 5px; color: var(--accent-color); font-weight: bold; letter-spacing: 2px;">
                é¡¹ç›®ä¿¡æ¯
            </div>
            <div class="meta-item">
                <span class="meta-label">é¡¹ç›®ä»“åº“</span>
				<span class="meta-value">
					<a href="https://github.com/momo24h/daodejing1" target="_blank" onclick="event.stopPropagation();" style="color: inherit; text-decoration: none; border-bottom: 1px dashed var(--guide-color);">
						https://github.com/momo24h/daodejing1
					</a>
				</span>            
			</div>
            <div class="meta-item">
                <span class="meta-label"></span>
                <span class="meta-value">âš ï¸ ä»“åº“å†…æœ‰ã€å­—å…¸ã€‘ã€å­—å…¸å·¥å…·ã€‘çš„ä»‹ç»</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">æ‰€ç”¨åº•æœ¬</span>
                <span class="meta-value">
					<a href="https://github.com/momo24h/daodejing" target="_blank" style="color: inherit; text-decoration: none; border-bottom: 1px dashed var(--guide-color);">
            			è€å­é“å¾·ç»ï¼šå››ç§åŸæ–‡è¡¨.pdf
        			</a> ä¸­çš„æ ¡è®¢æ–‡
				</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">ä½¿ç”¨åè®®</span>
                <span class="meta-value">CC0 1.0</span>
            </div>

            <div style="text-align: right; margin: 15px 0 5px; color: var(--accent-color); font-weight: bold; letter-spacing: 2px;">
            	æ“ä½œæŒ‡å—
            </div>
            <div class="meta-item">
                <span class="meta-label">ç‚¹å‡» [ æ ‡é¢˜è¡Œ ] </span>
                <span class="meta-value">å±•å¼€/å…³é—­ åŒ…å«èŒƒå›´å†…çš„è¯‘æ–‡</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">ç‚¹å‡» [ æ®µé¦–ç¼©è¿› ]</span>
                <span class="meta-value">å±•å¼€/å…³é—­ åŒ…å«èŒƒå›´å†…çš„è¯‘æ–‡</span>
            </div>
           	<div class="meta-item">
                <span class="meta-label">è‡ªåŠ¨å±•å¼€</span>
                <span class="meta-value">åˆ·æ–°é¡µé¢æ—¶è‡ªåŠ¨å±•å¼€æ‰€æœ‰è¯‘æ–‡</span>
            </div>
           	<div class="meta-item">
                <span class="meta-label">åŒæ—¶å±•å¼€</span>
                <span class="meta-value">å±•å¼€è¯‘æ–‡æ—¶åŒæ—¶ä¹Ÿå±•å¼€æ³¨é‡Š</span>
            </div>
        </div>
    </div>

    <div id="moving-content">
        <div id="book-canvas"></div>
        <footer><div class="end-mark">END</div></footer>
    </div>
</div>

<script>
(() => {
    "use strict";
    
    // --- çŠ¶æ€ä¸åˆå§‹åŒ– ---
    let isSyncEnabled = (localStorage.getItem('sync-enabled') !== 'false');
    let isExpandEnabled = (localStorage.getItem('auto-expand-enabled') === 'true');
    let currentTheme = parseInt(localStorage.getItem('user-theme')) || 1;

    const canvas = document.querySelector('#book-canvas');
    const navPanel = document.querySelector('#nav-panel');
    const monitor = document.querySelector('#error-monitor');
    const themeBtn = document.querySelector('#theme-toggle');
    const syncSwitch = document.querySelector('#sync-toggle');
    const expandSwitch = document.querySelector('#expand-toggle');
    const overlay = document.querySelector('#overlay');
    const mainTitle = document.querySelector('.main-title');

    // æ’•è£‚æ•ˆæœæ§åˆ¶é€»è¾‘
    const revealBtn = document.querySelector('#reveal-btn');
    const revealArea = document.querySelector('#reveal-area');
    const infoLayer = document.querySelector('#info-layer');
    const movingContent = document.querySelector('#moving-content');

    revealBtn.onclick = () => {
		revealArea.classList.toggle('open');
		revealBtn.classList.toggle('active');
    };

    // åˆå¹¶æ•°æ®
    const bookData = JSON.parse(document.querySelector('#data-part-1').textContent)
                     .concat(JSON.parse(document.querySelector('#data-part-2').textContent));

    const Utils = {
        inject: text => text.replace(/\[term(.*?)\]/g, '<span class="term-tag">$1</span>'),
        jumpTo: (idx) => {
			const target = document.getElementById(`chapter-${idx}`);
            if (target) {
                // ä½¿ç”¨ scrollIntoView ç›´æ¥æ»šåŠ¨åˆ°å…ƒç´ é¡¶éƒ¨
                target.scrollIntoView({ behavior: 'auto', block: 'start' });

                // åŠ¨ç”»æ•ˆæœå¤„ç†
                target.classList.remove('flash-active');
                void target.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                target.classList.add('flash-active');
            }
        },
        resetAnnotation: (box) => {
            const details = box.querySelector('.details-content');
            const indicator = box.querySelector('.details-indicator');
            if (details) details.style.display = 'none';
            if (indicator) indicator.style.display = 'block';
        }
    };

    // --- æ•°æ®æ ¡éªŒ ---
    const validationErrors = [];
    bookData.forEach((chapter, cIdx) => {
        const title = chapter[0].split('ğŸŒ±')[0];
        const rawParas = chapter[0].split('ğŸŒ±').slice(1);
        const transGroups = chapter.slice(1);
        if (rawParas.length !== transGroups.length) {
            validationErrors.push(`ã€${title}ã€‘åŸæ–‡æœ‰ ${rawParas.length} æ®µï¼Œä½†è¯‘æ–‡æœ‰ ${transGroups.length} ç»„ã€‚`);
        }
        transGroups.forEach((group, gIdx) => {
            group.forEach((text, tIdx) => {
                const cleanText = text.trim();
                if (tIdx > 0 && !cleanText.startsWith('âœï¸') && !cleanText.startsWith('ğŸ“')) {
                    validationErrors.push(`ã€${title}ã€‘ç¬¬ ${gIdx+1} ç»„ç¬¬ ${tIdx+1} é¡¹å¿…é¡»ä»¥ âœï¸ æˆ– ğŸ“ å¼€å§‹ã€‚`);
                }
                if (cleanText.startsWith('ğŸ“') && tIdx !== group.length - 1) {
                    validationErrors.push(`ã€${title}ã€‘ç¬¬ ${gIdx+1} ç»„çš„ ğŸ“ å¿…é¡»æ˜¯æœ€åä¸€é¡¹ã€‚`);
                }
            });
        });
    });

    if (validationErrors.length > 0) {
        monitor.style.display = 'block';
        monitor.innerHTML = `<b>åº•æœ¬æ ¡éªŒä¸é€šè¿‡ï¼š</b><br>â€¢ ${validationErrors.join('<br>â€¢ ')}`;
        return; 
    }

    // --- æ¸²æŸ“é€»è¾‘ ---
    const renderAnnotation = (annoGroup, box) => {
        if (!annoGroup || !annoGroup.length) return null;
        const introDiv = document.createElement('div');
        introDiv.innerHTML = Utils.inject(annoGroup[0]);
        box.appendChild(introDiv);

        const detailsContent = document.createElement('div');
        detailsContent.className = 'details-content';
        const ol = document.createElement('ol'); 
        let hasDetails = false, lastNode = null;

        for (let i = 1; i < annoGroup.length; i++) {
            const str = annoGroup[i].trim();
            if (str.startsWith('âœï¸')) {
                hasDetails = true;
                const li = document.createElement('li');
                li.innerHTML = Utils.inject(str.replace(/^âœï¸/, '').trim());
                ol.appendChild(li);
            } else if (str.startsWith('ğŸ“')) {
                hasDetails = true;
                lastNode = document.createElement('div');
                lastNode.className = 'last-container';
                str.replace(/^ğŸ“/, '').trim().split('[split]').forEach(seg => {
                    const p = document.createElement('p');
                    p.style.textIndent = "2em"; p.style.margin = "0 0 8px 0";
                    p.innerHTML = Utils.inject(seg);
                    lastNode.appendChild(p);
                });
            }
        }

        if (hasDetails) {
            const indicator = document.createElement('div');
            indicator.className = 'details-indicator';
            indicator.textContent = 'â–¾';
            indicator.onclick = (e) => { 
                e.stopPropagation(); 
                detailsContent.style.display = 'block'; 
                indicator.style.display = 'none'; 
            };
            const itemWrap = document.createElement('div');
            itemWrap.className = 'item-container';
            if (ol.children.length > 0) itemWrap.appendChild(ol);
            detailsContent.appendChild(itemWrap);
            if (lastNode) detailsContent.appendChild(lastNode);
            box.appendChild(indicator);
            box.appendChild(detailsContent);
            return indicator;
        }
        return null;
    };

    bookData.forEach((chapterData, idx) => {
        const chapterSection = document.createElement('section');
        chapterSection.id = `chapter-${idx}`;
        chapterSection.style.padding = "10px";
        
        const parts = chapterData[0].split('ğŸŒ±');
        const title = parts[0];
        const paragraphs = parts.slice(1);
        const allAnnos = chapterData.slice(1);

        const h2 = document.createElement('h2');
        h2.textContent = title;
        chapterSection.appendChild(h2);

        const chapterBoxes = [];
        paragraphs.forEach((pText, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'section-wrapper';
            const pNode = document.createElement('p');
            pNode.className = 'content-text';
            pNode.innerHTML = Utils.inject(pText);
            
            const trigger = document.createElement('div');
            trigger.className = 'indent-trigger';
            
            const box = document.createElement('div');
            box.className = 'annotation-box';
            chapterBoxes.push(box);

            const indicator = renderAnnotation(allAnnos[i], box);

            trigger.onclick = () => {
                if (box.style.display !== 'block') {
                    box.style.display = 'block';
                    if (isSyncEnabled && indicator) { indicator.click(); }
                } else {
                    box.style.display = 'none';
                    Utils.resetAnnotation(box);
                }
            };
            wrapper.append(trigger, pNode, box);
            chapterSection.appendChild(wrapper);
        });

        h2.onclick = () => {
            const anyOpen = chapterBoxes.some(b => b.style.display === 'block');
            chapterBoxes.forEach(b => { 
                if (anyOpen) {
                    b.style.display = 'none';
                    Utils.resetAnnotation(b);
                } else {
                    b.style.display = 'block';
                    if (isSyncEnabled) {
                        const ind = b.querySelector('.details-indicator');
                        if (ind && ind.style.display !== 'none') ind.click();
                    }
                }
            });
        };

        const navItem = document.createElement('div');
        navItem.className = 'nav-item';
        navItem.textContent = title;
        navItem.onclick = () => { Utils.jumpTo(idx); navPanel.classList.remove('open'); overlay.style.display='none'; };
        navPanel.appendChild(navItem);
        canvas.appendChild(chapterSection);
    });

    // --- ä¸»é¢˜ä¸æ§åˆ¶é€»è¾‘ä¼˜åŒ– ---
    const applyTheme = (themeId) => {
        document.documentElement.setAttribute('data-theme', themeId);
        const idSpan = themeBtn.querySelector('.theme-id');
        if(idSpan) idSpan.textContent = themeId;
        
        localStorage.setItem('user-theme', themeId);
        if(themeId === 2 || themeId === 3) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    };

    applyTheme(currentTheme);
    if (syncSwitch) syncSwitch.checked = isSyncEnabled;
    if (expandSwitch) expandSwitch.checked = isExpandEnabled;

    themeBtn.onclick = (e) => {
        e.stopPropagation();
        currentTheme = currentTheme >= 5 ? 1 : currentTheme + 1;
        applyTheme(currentTheme);
    };

    syncSwitch.onchange = (e) => { 
        isSyncEnabled = e.target.checked; 
        localStorage.setItem('sync-enabled', isSyncEnabled);
    };

    expandSwitch.onchange = (e) => {
        isExpandEnabled = e.target.checked;
        localStorage.setItem('auto-expand-enabled', isExpandEnabled);
    };

    document.querySelector('#menu-btn').onclick = () => { 
        navPanel.classList.add('open'); 
        overlay.style.display = 'block'; 
    };
    
    overlay.onclick = () => { 
        navPanel.classList.remove('open'); 
        overlay.style.display = 'none'; 
    };

    if (mainTitle) {
        mainTitle.onclick = () => {
            const allBoxes = Array.from(document.querySelectorAll('.annotation-box'));
            const anyOpen = allBoxes.some(b => b.style.display === 'block');
            document.querySelectorAll('#book-canvas h2').forEach(h2 => {
                const boxes = h2.parentElement.querySelectorAll('.annotation-box');
                const isChapterOpen = Array.from(boxes).some(b => b.style.display === 'block');
                if (anyOpen) {
                    if (isChapterOpen) h2.click(); 
                } else {
                    h2.click(); 
                }
            });
        };
    }

    if (isExpandEnabled && mainTitle) {
        mainTitle.click();
    }
    
})();
</script>
</body>
</html>